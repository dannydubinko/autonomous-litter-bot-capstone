ekf_filter_node:
    ros__parameters:
        frequency: 30.0
        sensor_timeout: 0.2  # Relaxed from 0.1 to allow for occasional lag
        two_d_mode: true
        transform_time_offset: 0.0
        transform_timeout: 0.0
        print_diagnostics: true
        debug: false
        publish_tf: true

        map_frame: map
        odom_frame: odom
        base_link_frame: base_footprint
        world_frame: odom

        # -------------------------------------
        # SOURCE 1: RF2O (LiDAR Odometry)
        # Provides the Position (X, Y) and Orientation (Yaw)
        # -------------------------------------
        odom0: /odom_rf2o
        odom0_config: [true,  true,  false,  # X, Y, Z
                       false, false, true,   # Roll, Pitch, Yaw
                       false, false, false,  # VX, VY, VZ
                       false, false, false,  # Vroll, Vpitch, Vyaw
                       false, false, false]  # Ax, Ay, Az
        
        odom0_queue_size: 10
        odom0_differential: false
        odom0_relative: false
        
        # COMMENTED OUT TO PREVENT REJECTION
        # odom0_pose_rejection_threshold: 5.0

        # -------------------------------------
        # SOURCE 2: IMU (MPU 6050)
        # Provides the Turn Speed (Yaw Velocity)
        # We DO NOT fuse Linear Acceleration (Ax, Ay) because the Go1 stomping creates noise.
        # -------------------------------------
        imu0: /imu/data
        
        # X, Y, Z
        # Roll, Pitch, Yaw  <-- WE CHANGED THIS LINE
        # VX, VY, VZ
        # VRoll, VPitch, VYaw
        # Ax, Ay, Az
        
        imu0_config: [false, false, false,
                      true,  true,  false, # Fuse ROLL and PITCH. Ignore Yaw (it drifts).
                      false, false, false,
                      false, false, true,  # Fuse Yaw Velocity (Angular Velocity Z)
                      false, false, false] # No Linear Accel (too noisy on a dog)

        imu0_differential: false
        imu0_relative: true   # <--- REQUIRED if fusing orientation. Resets IMU to 0 on start.
        imu0_queue_size: 10
        imu0_remove_gravitational_acceleration: true

        # -------------------------------------
        # CONTROL INPUT (DISABLED)
        # Prevents the "Prediction vs Reality" fight
        # -------------------------------------
        use_control: false 

        # -------------------------------------
        # COVARIANCE TUNING
        # -------------------------------------
        process_noise_covariance: [0.05, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.05, 0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.06, 0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.03, 0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.03, 0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.06, 0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.025, 0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.025, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.04, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.01, 0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.01, 0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.02, 0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.01, 0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.01, 0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.015]

        initial_estimate_covariance: [1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9, 1e-9]